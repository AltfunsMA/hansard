---
title: "Australian coal Hansard IEA statistics"
author: "Alfonso M Arranz"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: false
    df_print: paged
---

```{r, echo = FALSE}
pacman::p_load(ggtext, tidyverse, tidytable, scales, stringr, forcats, purrr, ggplot2, lubridate, tibble, zoo, deeptime)

source("scripts/report/coal_topics_FUNS.R")
source("scripts/report/iea_FUNS.R")


ieacoal <- fread.("/data/hansard/coal_data/general_stats/COAL_WCS-2020-1-EN-20210301T100015.csv")


export_by_destination <- fread.("coal_data/general_stats/COAL_EXPORTS-2020-1-EN-20200513T101527.csv")




knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, results = 'asis', cache.lazy = FALSE, width = 9)

```

### Data overview

```{r}

names(ieacoal)

```


```{r}

names(export_by_destination)

```



```{r}

ieacoal %>% filter.(FLOW %in% c("IMPORTS", 'EXPORTS')) %>%  distinct.(PRODUCT, FLOW)

```


```{r}

export_by_destination %>% distinct.(PRODUCT)

```


See coal documentation
http://wds.iea.org/wds/pdf/coal_documentation.pdf


"MBROWN" and "MHARD" seen in the IEA general coal file are not documented but seem to correspond to HARDCOAL and BROWN in the export file.



#### Australian export destinations

```{r, echo = FALSE}

exportsaus <- export_by_destination %>% 
  filter.(Country == "Australia", !is.na(Value), Value > 0, PRODUCT %in% c("HARDCOAL", "BROWN")) %>%
  mutate.(simple_country = dplyr::recode(Destination, !!!ct_names)) %>% 
  filter.(simple_country != "Total Exports")


top_ausexports <- top_iea_value(exportsaus, N = 6)

top_ausexports

```



```{r}

aus_exports <- exportsaus %>%
  mutate.(simple_country = fct_other(simple_country, keep = top_ausexports$simple_country))

# aus_coal_exports_gg <- aus_exports %>% 
#   basic_jinchukou() +
#   imports_add_on
# 
# 
# ggsave(paste0("coal_output/images4paper/aus_coal_exports.png"), aus_coal_exports_gg)
# 
# aus_coal_exports_gg

```

### EIA data    

```{r}
countries <- c("India", "China", "Japan", "South Korea", "Taiwan")

eia <- read_csv("/data/hansard/coal_data/general_stats/EIA_Coal_SeriesExport-03-20-2022_16-38-24_clean.csv") %>% 
  select.(contains(countries)) %>% 
  mutate.(year = 1980:2020)

short_to_metric <- 0.907185


eia_coal <- eia %>% 
  rename_with.(~str_remove_all(.x, " imports,|, Annual")) %>% 
  mutate_all(as.numeric) %>% 
  pivot_longer(cols = -year, values_to = "k_short_tons") %>% 
  mutate(name = str_replace_all(name, " ((South )?[A-Za-z]+$)", "_\\1"),
         Mtonnes = k_short_tons/1000*short_to_metric) %>% 
  separate(name, sep = "_", into = c("type", "country"))


unique(eia_coal$type)

```


```{r}
eia_for_verification <- eia_coal %>% 
  filter(type %in% c("Coal")) %>% 
  mutate(simple_country = recode(country, "China" = "M. China")) %>% 
  select(year, simple_country, EIA_Mtonnes = Mtonnes)


eia_for_verification

```




#### IEA total coal imports


```{r, rows.print = 40}
ieaimports <- filt_ieacoal_products("IMPORTS") 


top_coal_importers <- ieaimports %>% 
  top_iea_value(N = 7)

top_coal_importers
```


```{r}

all_imports <- ieaimports %>%
  # filter.(simple_country %in% top_coal_importers$simple_country) %>%
  mutate.(simple_country = fct_other(simple_country, keep = top_coal_importers$simple_country))
# 
# main_coal_importers_gg <- all_imports %>% 
#   basic_jinchukou() +
#   imports_add_on

# 

```


```{r}
main_importers <- all_imports %>% 
  get_Mtonnes() %>% 
  select(imported_total = Mtonnes, simple_country, TIME)
```

There are some discrepancies between EIA and IEA data but not for the period where it would make a difference. It is nonetheless peculiar.

```{r}


main_importers %>% 
  rename(year = TIME) %>% 
  right_join(eia_for_verification) %>% 
  mutate(diff = imported_total - EIA_Mtonnes) %>% 
  filter(diff > 0.01) %>% 
  distinct(simple_country, year, diff)

```


```{r}
proportion <- aus_exports %>% 
  get_Mtonnes() %>% 
  left_join(main_importers, by = c("simple_country", "TIME")) %>% 
  mutate(Mtonnes = Mtonnes/imported_total) 
  
proportion %>% 
  summarize.(.by = simple_country, 
             mean_prop = scales::percent(mean(Mtonnes/imported_total)))
```


```{r}


aus_prop_gg <- bind_rows.(list("Australian exports (Mt)" = get_Mtonnes(aus_exports), "Prop. of country imports" = proportion), .id = "trade_type") %>% 
    filter(!(simple_country == "India" & TIME < 1995) ) %>%
  basic_jinchukou(group_by = c("TIME", "simple_country", "trade_type")) +
  facet_wrap(~trade_type, scales = "free") +
  # imports_add_on +
  labs(x = "", y = "", colour = "") +
  theme(text = element_text(family="Serif"),
        legend.position = "bottom")

  

ggsave(paste0("coal_output/", img_subfolder, "/aus_global_coal.png"), aus_prop_gg)

aus_prop_gg



```






```{r, height = 10}


aus_global_gg <- bind_rows.(list("Global imports" = all_imports, "Australian exports" = aus_exports), .id = "trade_type") %>% 
  mutate.(trade_type = fct_relevel(trade_type, "Global imports")) %>% 
  basic_jinchukou(group_by = c("TIME", "simple_country", "trade_type")) +
  facet_wrap(~trade_type, scales = "free") +
  imports_add_on +
  theme(legend.position = "bottom")

ggsave(paste0("coal_output/", img_subfolder, "/aus_global_coal_old.png"), aus_global_gg)

aus_global_gg



```



#### IEA total coal exports


```{r,  rows.print = 40}


ieaexports <- filt_ieacoal_products("EXPORTS") 

top_coal_exporters <- ieaexports %>% 
  filter.(!str_detect(simple_country, "Africa|Asia|World|European|OECD|Total|IEA|,|:")) %>% 
  top_iea_value(N = 8)

top_coal_exporters


```


```{r}


main_coal_exporters_gg <- ieaexports %>%
  filter.(simple_country %in% top_coal_exporters$simple_country) %>%
  filter.(!simple_country %in% c("Poland")) %>%
  basic_jinchukou() +
  imports_add_on +
  eras_add_on +
  geom_vline(xintercept = main_eras[3], linetype = "dashed")


ggsave(paste0("coal_output/", img_subfolder,"/main_coal_exporters.png"), main_coal_exporters_gg)

main_coal_exporters_gg


```
