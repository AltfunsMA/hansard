---
title: "Australian Hansard topic modelling analysis"
author: "Alfonso M Arranz"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: false
    df_print: paged
---

```{r, echo = TRUE}
pacman::p_load(stringr, tidyverse, scales, tidytable, deeptime, purrr, ggplot2, ggtext, glue)

params <- "k40_var0.05"
  
dtm_run_path <-  "coal_output/dtm/run_21Sep//all_2a_min_freq_150_21_09_21/"
  
docs_file <- "id_alliance_all_2a.csv"
  
  

source('scripts/report/coal_topics_FUNS.R')

paragraphs_df <- fread.(paste0("coal_data/04_model_inputs/preprocessed_datasets/", docs_file)) %>% 
  select.(-contains("lucy"))


```


```{r, echo=FALSE}

# Data input

topic_nums <- as.character(as.numeric(str_extract(params, "\\d{2}")) - 1)

topic_distributions <- fread.(paste0(dtm_run_path, "/analysis/", params, "_doc_topic_distribution.csv")) %>% 
  mutate.(row_score = rowSums(select.(., `0`:sym(topic_nums))),
          across.(c(`0`:sym(topic_nums)), ~.x/row_score))



topic_labels <- fread.(paste0(dtm_run_path, "analysis/", params, "_labelling.csv"))



knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, results = 'asis', cache.lazy = FALSE)
```


## Raw number of docs by party
```{r}

ggplot(paragraphs_df) +
  geom_bar(aes(year, fill = final_alliance)) +
  basic_add_ons +
  labs(y = "Standardised (~300 token) paragraphs per year")

```



### relative to parliamentary activity

https://www.aph.gov.au/-/media/02_Parliamentary_Business/22_Chamber_Documents/224_Statistics/House_of_Representatives/Statistics_Historical/legislation_statistics.pdf?la=en&hash=6ADCACEE5832882C1E8660A06563DC9200F6EC54

https://www.aph.gov.au/Parliamentary_Business/Bills_Legislation/Bills_Lists/Details_page?blsId=legislation%2Fbillslst%2Fbillslst_c203aa1c-1876-41a8-bc76-1de328bdb726


dividing the counts of paragraphs discussing coal by the number of bills passed in parliament that year as a proxy for parliamentary activity. The results are then normalised so that 1 corresponds to the largest amount of discussion by any party, which corresponds to the Greens in 2019. Parliament has arguably become more active over time in part due to an increase in the number of MPs and Senators and in part due to the increased requirements of a larger population and a more complex economy.

With those differences taken into account, the periods between 1940 and 1960 and post-2005 stand out, corresponding respectively to 

```{r}
# NB: import of rightmost 4 columns is not accurate bc of odd formatting of original PDF table

parl_activity <- fread.("terms/parl_stats.csv", fill = TRUE, col.names = c("year", "total_bills", "private_bills", "senate_bills", "chamber_bills", "house_bills", "acts")) %>% 
  mutate.(year = as.numeric(str_remove(year, "\\*"))) %>% 
  select.(year, total_bills)
  

relative_discussion <- paragraphs_df %>% 
  filter.(year < 2021) %>% 
  left_join.(parl_activity) %>% 
  summarize.(.by = c(year, final_alliance),
             paras_by_party = n()/total_bills) %>% 
  distinct.()

max_discussion <- relative_discussion %>% 
  summarize.(.by = year, total = sum(paras_by_party)) %>% 
  pull(total) %>% 
  max()


rel_discussion_norm <- relative_discussion %>% 
  mutate.(weighted_paras = paras_by_party/max_discussion)
  

```

#### largest amount of discussion
```{r}

relative_discussion %>% 
  filter(paras_by_party == max(paras_by_party))

```


#### years above the 90% value

```{r}

relative_discussion %>% 
  filter(paras_by_party > quantile(paras_by_party, 0.9)) %>% 
  distinct(year) %>% 
  pull() %>% 
  sort() %>% 
  cat(sep = ", ")

```



```{r}
discussion_parties_gg <- rel_discussion_norm %>% 
  rename.(Party = final_alliance) %>% 
  ggplot() +
  geom_col(aes(year, weighted_paras, fill = Party)) +
  basic_add_ons +
  labs(y = "Discussion level") + 
  eras_add_on
  

ggsave("coal_output/images4paper/discussion_level_parties.png", discussion_parties_gg)


discussion_parties_gg

```

### Bringing various elements together

filtering the minimal part of "other" in the period prior to 1975 and in general any topic before 1910 because the amounts of information are tiny and lead to wild fluctuations in proportion.

```{r, echo = TRUE}

# From this article https://www.blueprintinstitute.org.au/polling_data
coal_mining_regions <- "Kalgoorlie|Parkes|Lyne|Hunter|calare|shortland|Flynn|Maranoa|gippsland|connor|capricornia"

all_topic_scores_df <- paragraphs_df %>% 
  select.(doc_id, electorate, final_alliance, year) %>% 
  left_join.(select.(topic_distributions, -c(V1, year))) %>% 
  pivot_longer.(c(`0`:sym(topic_nums)), names_to = "topic_no", values_to = "score") %>% 
  mutate.(topic_no = as.integer(topic_no)) %>% 
  left_join.(topic_labels) %>% 
  left_join.(select(elections, year, era, legislature)) %>% 
  filter.(year > minimum_display_year, 
          !(final_alliance == "Other" & year < 1975)) %>% 
  mutate.(label = paste0(str_pad(topic_no, 2, "left", "0"), "_", label),
          mining_region = str_detect(electorate, regex(coal_mining_regions, ignore_case = T)),
          labor_mining_region = final_alliance == "Labor" & mining_region == TRUE,
          country_mining_region = final_alliance == "Country" & mining_region == TRUE)
  
  
```

```{r}


interesting_labels <-c("environment", "trade", "workers", "supply", "economy", "politics")
# 
# discussion_categories_gg <- all_topic_scores_df %>% 
#   process_labs(category, selection = interesting_labels,  party_var = NULL, time_var = era) %>% 
#   left_join(relative_discussion) %>% 
#   summarise.(.by = c(year, category),
#              cat_weighted_paras = sum(weighted_paras)*prop) %>% 
#   distinct.() %>% 
#   ggplot() +
#   geom_col(aes(year, cat_weighted_paras, fill = category)) +
#     basic_add_ons +
#   scale_fill_manual(values = category_colours) +
#   labs(y = "Discussion level", fill = "Category") + 
#   eras_add_on 
#   
#   
# 
# ggsave("coal_output/images4paper/discussion_level_categories.png", discussion_categories_gg)
# 
# discussion_categories_gg

```






```{r}

all_topic_scores_df %>% 
  count.(mining_region, final_alliance) %>% 
  mutate.(.by = mining_region, prop = scales::percent(N/sum(N))) %>% 
  filter.(mining_region == TRUE)


```



### Foci of each party relative to average

(Replicating MH's Fig. 10)


```{r, width= 11}

party_gg <- plot_differences(label)

# g <- ggplot_gtable(ggplot_build(party_gg))

# 
# strip_both <- which(grepl('strip-', g$layout$name))
# fills <-  c(party_colours, "darkgoldenrod4", "darkred")
# 
# strips <- which(grepl('strip-', g$layout$name))
# 
# 
# for (i in seq_along(strips)) {
#   k <- which(grepl('rect', g$grobs[[strips[i]]]$grobs[[1]]$childrenOrder))
#   g$grobs[[strips[i]]]$grobs[[1]]$children[[k]]$gp$fill <- fills[i]
#   
# }
# 
# 
# grid::grid.newpage()
# grid::grid.draw(g)



ggsave("coal_output/images4paper/party_diffs.png", party_gg)

party_gg


```


  
```{r}

# plot_differences(category)

```

 

### Manually aggregated categorys

```{r}



all_topic_scores_df %>%
  process_labs(category, interesting_labels) %>%
  plot_w_legislature(category)


# ggsave("coal_output/images4paper/four_cats_party.png")

```




```{r}

six_cats_gg <- all_topic_scores_df %>%
  process_labs(category,
               interesting_labels,
               party_var = NULL,
               time_var = legislature) %>%
  ggplot() +
  geom_line(aes(year, prop, colour = category)) +
  basic_add_ons +
  scale_colour_manual(values = category_colours) +
  eras_add_on +
  plot_gov_add_on +
  labs(y = "", colour = "Category")
  
  
ggsave("coal_output/images4paper/six_categories.png", six_cats_gg)

six_cats_gg

```



### TF-IDF 'best categories'

best used to "confirm" that we're not selecting the wrong thing.

```{r}

all_topic_scores_df %>%
  process_labs(most_relevant_Eurovoc_label, "all", NULL) %>%
  plot_w_legislature(most_relevant_Eurovoc_label, NULL)


```


### By individual topic and era


```{r}


plot_df <- all_topic_scores_df %>% 
  filter.(!is.na(category)) %>% 
  process_labs(label, 
               "all", 
               party_var = NULL, 
               time_var = era)

for(subl in unique(plot_df$label)) {
  
  cat(subl)

  print(plot_df %>% 
    filter.(label == subl) %>% 
    plot_w_legislature(label, NULL, get_avg_labels = T) +
    guides(colour = "none")) 
  

  # ggsave(paste0("coal_output/images4paper/all_", subl, ".png"))
  
}





```





### By individual topic and party

```{r}


label_plot <- all_topic_scores_df %>% 
  filter.(!is.na(category)) %>% 
  # filter.(final_alliance %in% c("Liberal", "Labor")) %>% 
  process_labs(label, "all")



for(subl in unique(label_plot$label)) {

    cat(subl)
  
  print(label_plot %>% 
    filter.(label == subl) %>% 
      {if(str_detect(subl, "taxes")) filter.(., year > 1917) else .} %>% 
    plot_w_legislature(label) +
    theme(text = element_text(size=20)) +
      labs(y = "") +
    guides(colour = "none"))
  

  if(str_detect(subl, "taxes|budget|climate change|environmental impacts|big business|farming|electorate|coalminers|infrastructure|carbon"))
  
  ggsave(paste0("coal_output/images4paper/party_", subl, ".png"))
  
}


```

  